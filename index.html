<!DOCTYPE html>
<title>Trading Script Test</title>

<button type="button" onclick="testws()">Start Script</button>

<div id="timestamp"></div>
<div id="1"></div>
<div id="2"></div>
<div id="3"></div>
<div id="4"></div>
<div id="5"></div>
<div id="6"></div>
<div id="7"></div>
<div id="8"></div>
<div id="9"></div>
<div id="10"></div>
<div id="11"></div>
<div id="12"></div>
<div id="13"></div>
<div id="14"></div>
<div id="15"></div>
<div id="16"></div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/forge/0.8.2/forge.all.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/centrifugal/centrifuge-js@2.X.X/dist/centrifuge.min.js"></script>

<script>

function testws() {

    var host = "wss://ws.indodax.com/ws/";
    var token = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxIiwiaW5mbyI6eyJuYW1lIjoiUHVibGljIn19.VJAHTrrfwxceSITpuPBl75LVM5bgojKGiUTOwCZxw-k";

    var timestamp1;
    var timestamp2;
    var timestamp3;

    var balance_json;
    var balance_idr;
    var balance_hold_idr;
    var balance_btc;
    var balance_hold_btc;

    var pricechange_ask2nd;
    var pricechange_ask1st;
    var pricechange_market_gap;
    var pricechange_bid1st;
    var pricechange_bid2nd;

    var price_ask2nd;
    var price_ask1st;
    var market_gap;
    var price_bid1st;
    var price_bid2nd;

    var order_ask2nd;
    var order_ask1st;
    var order_bid1st;
    var order_bid2nd;

    var vol_ask2nd;
    var vol_ask1st;
    var vol_bid1st;
    var vol_bid2nd;

    var counter=0;
    var mode="buy";
 
    var centrifuge = new Centrifuge(host);
    centrifuge.setToken(token);

    centrifuge.connect();

    centrifuge.subscribe("btcidr.depth", function(message) {

        //const unixTimestamp = 1575909015

        const milliseconds = Date.now(); // 1575909015000

        const dateObject = new Date(milliseconds);

        const timestamp1 = dateObject.toLocaleString(); //2019-12-9 10:30:15

        //timestamp1 = Date.now();

        balance_json = JSON.parse(getInfo());
        balance_idr = balance_json.return.balance.idr;
        balance_hold_idr = balance_json.return.balance_hold.idr;
        balance_btc = balance_json.return.balance.btc;
        balance_hold_btc = balance_json.return.balance_hold.btc;

        pricechange_ask2nd = message.data.ask[1].price-price_ask2nd;
        pricechange_ask1st = message.data.ask[0].price-price_ask1st;
        pricechange_market_gap = (message.data.ask[0].price-message.data.bid[0].price)-market_gap;
        pricechange_bid1st = message.data.bid[0].price-price_bid1st;
        pricechange_bid2nd = message.data.bid[1].price-price_bid2nd;

        price_ask2nd = message.data.ask[1].price;
        price_ask1st = message.data.ask[0].price;
        market_gap = message.data.ask[0].price-message.data.bid[0].price;
        price_bid1st = message.data.bid[0].price;
        price_bid2nd = message.data.bid[1].price;

        order_ask2nd = message.data.ask[1].order;
        order_ask1st = message.data.ask[0].order;
        order_bid1st = message.data.bid[0].order;
        order_bid2nd = message.data.bid[1].order;

        vol_ask2nd = Math.round(price_ask2nd*order_ask2nd);
        vol_ask1st = Math.round(price_ask1st*order_ask1st);
        vol_bid1st = Math.round(price_bid1st*order_bid1st);
        vol_bid2nd = Math.round(price_bid2nd*order_bid2nd);

        document.getElementById("timestamp").innerHTML = timestamp1;

        document.getElementById("1").innerHTML = pricechange_ask2nd;
        document.getElementById("2").innerHTML = pricechange_ask1st;
        document.getElementById("3").innerHTML = pricechange_market_gap;
        document.getElementById("4").innerHTML = pricechange_bid1st;
        document.getElementById("5").innerHTML = pricechange_bid2nd;

        document.getElementById("6").innerHTML = price_ask2nd+" "+order_ask2nd+" "+vol_ask2nd
        document.getElementById("7").innerHTML = price_ask1st+" "+order_ask1st+" "+vol_ask1st
        document.getElementById("8").innerHTML = market_gap;
        document.getElementById("9").innerHTML = price_bid1st+" "+order_bid1st+" "+vol_bid1st
        document.getElementById("10").innerHTML = price_bid2nd+" "+order_bid2nd+" "+vol_bid2nd

        document.getElementById("11").innerHTML = balance_idr;
        document.getElementById("12").innerHTML = balance_hold_idr;
        document.getElementById("13").innerHTML = balance_btc;
        document.getElementById("14").innerHTML = balance_hold_btc;
        document.getElementById("15").innerHTML = mode;

        // trade window closed
		if(market_gap<=50000 && (balance_hold_idr>0 || balance_hold_btc>0))
		{
            var open_orders_json = JSON.parse(openOrders());
            var open_orders_length = open_orders_json.return.orders.length;
            document.getElementById("16").innerHTML = "Trade window closed";

            if(open_orders_length>0)
            {
                var buy_open_orders_id = open_orders_json.return.orders[0].order_id;
                cancelOrder(buy_open_orders_id, "buy");
                var sell_open_orders_id = open_orders_json.return.orders[0].order_id;
    			cancelOrder(sell_open_orders_id, "sell");
            }
		}

        // trade window open
        if(market_gap>50000)
        {
            if(mode=="buy")
            {
                if(balance_idr>0 && balance_hold_idr==0)
                {
                    var new_buy = parseInt(price_bid1st)+1000;
                    tradeBuy("buy", (new_buy), balance_idr);
                    timestamp2 = Date.now();
                    document.getElementById("16").innerHTML = "Buy with Price "+new_buy;
                }

                if(balance_idr>0 && balance_hold_idr>0)
                {
                    var open_orders_json = JSON.parse(openOrders());
                    var buy_open_orders_id = open_orders_json.return.orders[0].order_id;
                    cancelOrder(buy_open_orders_id, "buy");
                    document.getElementById("16").innerHTML = "Cancel because IDR and Hold IDR >0";
                }

                if(balance_idr==0 && balance_hold_idr>0 && vol_bid1st<1.01*balance_hold_idr && vol_bid1st>0.99*balance_hold_idr)
                {
                    timestamp2 = Date.now();
                    document.getElementById("16").innerHTML = "Do nothing";
                    if((price_bid1st-price_bid2nd)!==1000)
                    {
                        var open_orders_json = JSON.parse(openOrders());
                        var buy_open_orders_id = open_orders_json.return.orders[0].order_id;
                        cancelOrder(buy_open_orders_id, "buy");
                        document.getElementById("16").innerHTML = "Cancel because Bid 1st - 2nd >1000";
                    }
                }

                if(balance_idr==0 && balance_hold_idr>0 && (vol_bid1st>1.01*balance_hold_idr || vol_bid1st<0.99*balance_hold_idr))
                {
                    document.getElementById("16").innerHTML = "Waiting before cancel";
                    if(timestamp1-timestamp2>3000)
                    {
                        var open_orders_json = JSON.parse(openOrders());
                        var buy_open_orders_id = open_orders_json.return.orders[0].order_id;
                        cancelOrder(buy_open_orders_id, "buy");
                        document.getElementById("16").innerHTML = "Cancel because of outdated volume";
                    }
                }

                if(balance_btc>0 || balance_hold_btc>0)
                {
                    if(open_orders_length>0)
                    {
                    var open_orders_json = JSON.parse(openOrders());
                    var buy_open_orders_id = open_orders_json.return.orders[0].order_id;
                    cancelOrder(buy_open_orders_id, "buy");
                    }
                    mode="sell";
                    document.getElementById("16").innerHTML = "Change mode to sell";
                }

            }
            //============================================
            if(mode=="sell")
            {
                if(balance_btc>0 && balance_hold_btc==0)
                {
                    var new_sell = parseInt(price_ask1st)-1000;
                    tradeSell("sell", (new_sell), balance_btc);
                    timestamp3 = Date.now();
                    document.getElementById("16").innerHTML = "Sell with Price "+new_sell;
                }

                if(balance_btc>0 && balance_hold_btc>0)
                {
                    var open_orders_json = JSON.parse(openOrders());
                    var sell_open_orders_id = open_orders_json.return.orders[0].order_id;
                    cancelOrder(sell_open_orders_id, "sell");
                    document.getElementById("16").innerHTML = "Cancel because BTC and Hold BTC >0";
                }

                if(balance_btc==0 && balance_hold_btc>0 && order_ask1st<1.01*balance_hold_btc && order_ask1st>0.99*balance_hold_btc)
                {
                    timestamp3 = Date.now();
                    document.getElementById("16").innerHTML = "Do nothing";
                    if((price_ask2nd-price_ask1st)!==1000)
                    {
                        var open_orders_json = JSON.parse(openOrders());
                        var sell_open_orders_id = open_orders_json.return.orders[0].order_id;
                        cancelOrder(sell_open_orders_id, "sell");
                        document.getElementById("16").innerHTML = "Cancel because Ask 2nd - 1st >1000";
                    }
                }

                if(balance_btc==0 && balance_hold_btc>0 && (order_ask1st>1.01*balance_hold_btc || order_ask1st<0.99*balance_hold_btc))
                {
                    document.getElementById("16").innerHTML = "Waiting before cancel";
                    if(timestamp1-timestamp3>3000)
                    {
                        var open_orders_json = JSON.parse(openOrders());
                        var sell_open_orders_id = open_orders_json.return.orders[0].order_id;
                        cancelOrder(sell_open_orders_id, "sell");
                        document.getElementById("16").innerHTML = "Cancel because of outdated volume";
                    }
                }

                if(balance_btc<(10000/price_ask1st) && balance_hold_btc<(10000/price_ask1st))
                {
                    mode="buy";
                    document.getElementById("16").innerHTML = "Change mode to buy";
                }

            }
            
        }

        console.log("===");

        })
};

function getInfo(){
    var xhttp = new XMLHttpRequest();
    var formData = new FormData();

    var timestamp = Date.now();
    var plainText = "method=getInfo&timestamp="+timestamp;

    var hmac = forge.hmac.create();  
    hmac.start('sha512', '391b9db31c33f222319e97922d9d56afcd1716dd6e59f804fff719c5304dead56dde2c69ddaffd63');
    hmac.update(plainText);  
    var hashText = hmac.digest().toHex();

    formData.append("method","getInfo");
    formData.append("timestamp",timestamp);

    xhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
           // Typical action to be performed when the document is ready:
            
           //document.getElementById("demo").innerHTML = xhttp.responseText;

        }
    };
    xhttp.open("POST", "https://indodax.com/tapi/?"+plainText, false);
    xhttp.setRequestHeader('Key', 'MKUBW9PT-6Q9HP2HO-8WPCVEXR-FAMKTJTG-C321GX7P');
    xhttp.setRequestHeader('Sign', hashText);
    xhttp.send(formData);

    return xhttp.responseText;
}

function transHistory(){
	var xhttp = new XMLHttpRequest();
	var formData = new FormData();

	var timestamp = Date.now();
	var plainText = "method=transHistory&timestamp="+timestamp;

	var hmac = forge.hmac.create();  
    hmac.start('sha512', '391b9db31c33f222319e97922d9d56afcd1716dd6e59f804fff719c5304dead56dde2c69ddaffd63');
    hmac.update(plainText);  
    var hashText = hmac.digest().toHex();

	formData.append("method","transHistory");
  	formData.append("timestamp",timestamp);

	xhttp.onreadystatechange = function() {
    	if (this.readyState == 4 && this.status == 200) {
    	   // Typical action to be performed when the document is ready:
    	   	
    	   //document.getElementById("demo").innerHTML = xhttp.responseText;

    	}
	};
	xhttp.open("POST", "https://indodax.com/tapi/?"+plainText, false);
	xhttp.setRequestHeader('Key', 'MKUBW9PT-6Q9HP2HO-8WPCVEXR-FAMKTJTG-C321GX7P');
	xhttp.setRequestHeader('Sign', hashText);
	xhttp.send(formData);

	return xhttp.responseText;
}

function tradeHistory(){
	var xhttp = new XMLHttpRequest();
	var formData = new FormData();

	var timestamp = Date.now();
	var plainText = "method=tradeHistory&timestamp="+timestamp+"&pair=btc_idr";

	var hmac = forge.hmac.create();  
    hmac.start('sha512', '391b9db31c33f222319e97922d9d56afcd1716dd6e59f804fff719c5304dead56dde2c69ddaffd63');
    hmac.update(plainText);  
    var hashText = hmac.digest().toHex();

	formData.append("method","tradeHistory");
  	formData.append("timestamp",timestamp);
  	formData.append("pair","btc_idr")

	xhttp.onreadystatechange = function() {
    	if (this.readyState == 4 && this.status == 200) {
    	   // Typical action to be performed when the document is ready:
    	   	
    	   //document.getElementById("demo").innerHTML = xhttp.responseText;

    	}
	};
	xhttp.open("POST", "https://indodax.com/tapi/?"+plainText, false);
	xhttp.setRequestHeader('Key', 'MKUBW9PT-6Q9HP2HO-8WPCVEXR-FAMKTJTG-C321GX7P');
	xhttp.setRequestHeader('Sign', hashText);
	xhttp.send(formData);

	return xhttp.responseText;
}

function openOrders(){
	var xhttp = new XMLHttpRequest();
	var formData = new FormData();

	var timestamp = Date.now();
	var plainText = "method=openOrders&timestamp="+timestamp+"&pair=btc_idr";

	var hmac = forge.hmac.create();  
    hmac.start('sha512', '391b9db31c33f222319e97922d9d56afcd1716dd6e59f804fff719c5304dead56dde2c69ddaffd63');
    hmac.update(plainText);  
    var hashText = hmac.digest().toHex();

	formData.append("method","openOrders");
  	formData.append("timestamp",timestamp);
  	formData.append("pair","btc_idr")

	xhttp.onreadystatechange = function() {
    	if (this.readyState == 4 && this.status == 200) {
    	   // Typical action to be performed when the document is ready:
    	   	
    	   //document.getElementById("demo").innerHTML = xhttp.responseText;

    	}
	};
	xhttp.open("POST", "https://indodax.com/tapi/?"+plainText, false);
	xhttp.setRequestHeader('Key', 'MKUBW9PT-6Q9HP2HO-8WPCVEXR-FAMKTJTG-C321GX7P');
	xhttp.setRequestHeader('Sign', hashText);
	xhttp.send(formData);

	return xhttp.responseText;
}

function orderHistory(){
	var xhttp = new XMLHttpRequest();
	var formData = new FormData();

	var timestamp = Date.now();
	var plainText = "method=orderHistory&timestamp="+timestamp+"&pair=btc_idr";

	var hmac = forge.hmac.create();  
    hmac.start('sha512', '391b9db31c33f222319e97922d9d56afcd1716dd6e59f804fff719c5304dead56dde2c69ddaffd63');
    hmac.update(plainText);  
    var hashText = hmac.digest().toHex();

	formData.append("method","orderHistory");
  	formData.append("timestamp",timestamp);
  	formData.append("pair","btc_idr")

	xhttp.onreadystatechange = function() {
    	if (this.readyState == 4 && this.status == 200) {
    	   // Typical action to be performed when the document is ready:
    	   	
    	   //document.getElementById("demo").innerHTML = xhttp.responseText;

    	}
	};
	xhttp.open("POST", "https://indodax.com/tapi/?"+plainText, false);
	xhttp.setRequestHeader('Key', 'MKUBW9PT-6Q9HP2HO-8WPCVEXR-FAMKTJTG-C321GX7P');
	xhttp.setRequestHeader('Sign', hashText);
	xhttp.send(formData);

	return xhttp.responseText;
}

function cancelOrder(order_id, type){
	var xhttp = new XMLHttpRequest();
	var formData = new FormData();

	var timestamp = Date.now();
	var plainText = "method=cancelOrder&timestamp="+timestamp+"&pair=btc_idr&order_id="+order_id+"&type="+type;

	var hmac = forge.hmac.create();  
    hmac.start('sha512', '391b9db31c33f222319e97922d9d56afcd1716dd6e59f804fff719c5304dead56dde2c69ddaffd63');
    hmac.update(plainText);  
    var hashText = hmac.digest().toHex();

	formData.append("method","cancelOrder");
  	formData.append("timestamp",timestamp);
  	formData.append("pair","btc_idr");
  	formData.append("order_id", order_id);
  	formData.append("type",type);

	xhttp.onreadystatechange = function() {
    	if (this.readyState == 4 && this.status == 200) {
    	   // Typical action to be performed when the document is ready:
    	   	
    	   //document.getElementById("demo").innerHTML = xhttp.responseText;

    	}
	};
	xhttp.open("POST", "https://indodax.com/tapi/?"+plainText, false);
	xhttp.setRequestHeader('Key', 'MKUBW9PT-6Q9HP2HO-8WPCVEXR-FAMKTJTG-C321GX7P');
	xhttp.setRequestHeader('Sign', hashText);
	xhttp.send(formData);

	return xhttp.responseText;
}

function tradeBuy(type, price, idr){
	var xhttp = new XMLHttpRequest();
	var formData = new FormData();

	var timestamp = Date.now();
	var plainText = "method=trade&timestamp="+timestamp+"&pair=btc_idr&type="+type+"&price="+price+"&idr="+idr;

	var hmac = forge.hmac.create();  
    hmac.start('sha512', '391b9db31c33f222319e97922d9d56afcd1716dd6e59f804fff719c5304dead56dde2c69ddaffd63');
    hmac.update(plainText);  
    var hashText = hmac.digest().toHex();

	formData.append("method","trade");
  	formData.append("timestamp",timestamp);
  	formData.append("pair","btc_idr");
  	formData.append("type",type);
  	formData.append("price",price);
  	formData.append("idr",idr);

	xhttp.onreadystatechange = function() {
    	if (this.readyState == 4 && this.status == 200) {
    	   // Typical action to be performed when the document is ready:
    	   	
    	   //document.getElementById("demo").innerHTML = xhttp.responseText;

    	}
	};
	xhttp.open("POST", "https://indodax.com/tapi/?"+plainText, false);
	xhttp.setRequestHeader('Key', 'MKUBW9PT-6Q9HP2HO-8WPCVEXR-FAMKTJTG-C321GX7P');
	xhttp.setRequestHeader('Sign', hashText);
	xhttp.send(formData);

	return xhttp.responseText;
}

function tradeSell(type, price, btc){
	var xhttp = new XMLHttpRequest();
	var formData = new FormData();

	var timestamp = Date.now();
	var plainText = "method=trade&timestamp="+timestamp+"&pair=btc_idr&type="+type+"&price="+price+"&btc="+btc;

	var hmac = forge.hmac.create();  
    hmac.start('sha512', '391b9db31c33f222319e97922d9d56afcd1716dd6e59f804fff719c5304dead56dde2c69ddaffd63');
    hmac.update(plainText);  
    var hashText = hmac.digest().toHex();

	formData.append("method","trade");
  	formData.append("timestamp",timestamp);
  	formData.append("pair","btc_idr");
  	formData.append("type",type);
  	formData.append("price",price);
  	formData.append("btc",btc);

	xhttp.onreadystatechange = function() {
    	if (this.readyState == 4 && this.status == 200) {
    	   // Typical action to be performed when the document is ready:
    	   	
    	   //document.getElementById("demo").innerHTML = xhttp.responseText;

    	}
	};
	xhttp.open("POST", "https://indodax.com/tapi/?"+plainText, false);
	xhttp.setRequestHeader('Key', 'MKUBW9PT-6Q9HP2HO-8WPCVEXR-FAMKTJTG-C321GX7P');
	xhttp.setRequestHeader('Sign', hashText);
	xhttp.send(formData);

	return xhttp.responseText;
}
</script>